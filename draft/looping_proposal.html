<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <link href="data:text/css,%40charset%20%22utf%2D8%22%3B%0A%0A%2F%2A%2A%0A%20%2A%20markdown%2Ecss%0A%20%2A%0A%20%2A%20This%20program%20is%20free%20software%3A%20you%20can%20redistribute%20it%20and%2For%20modify%20it%20under%0A%20%2A%20the%20terms%20of%20the%20GNU%20Lesser%20General%20Public%20License%20as%20published%20by%20the%20Free%0A%20%2A%20Software%20Foundation%2C%20either%20version%203%20of%20the%20License%2C%20or%20%28at%20your%20option%29%20any%0A%20%2A%20later%20version%2E%0A%20%2A%0A%20%2A%20This%20program%20is%20distributed%20in%20the%20hope%20that%20it%20will%20be%20useful%2C%20but%20WITHOUT%0A%20%2A%20ANY%20WARRANTY%3B%20without%20even%20the%20implied%20warranty%20of%20MERCHANTABILITY%20or%20FITNESS%0A%20%2A%20FOR%20A%20PARTICULAR%20PURPOSE%2E%20See%20the%20GNU%20Lesser%20General%20Public%20License%20for%20more%0A%20%2A%20details%2E%0A%20%2A%0A%20%2A%20You%20should%20have%20received%20a%20copy%20of%20the%20GNU%20Lesser%20General%20Public%20License%0A%20%2A%20along%20with%20this%20program%2E%20If%20not%2C%20see%20http%3A%2F%2Fgnu%2Eorg%2Flicenses%2Flgpl%2Etxt%2E%0A%20%2A%0A%20%2A%20%40project%20%20%20%20%20%20Weblog%20and%20Open%20Source%20Projects%20of%20Florian%20Wolters%0A%20%2A%20%40version%20%20%20%20%20%20GIT%3A%20%24Id%24%0A%20%2A%20%40package%20%20%20%20%20%20xhtml%2Dcss%0A%20%2A%20%40author%20%20%20%20%20%20%20Florian%20Wolters%20%3Cflorian%2Ewolters%2E85%40googlemail%2Ecom%3E%0A%20%2A%20%40copyright%20%20%20%202012%20Florian%20Wolters%0A%20%2A%20%40cssdoc%20%20%20%20%20%20%20version%201%2E0%2Dpre%0A%20%2A%20%40license%20%20%20%20%20%20http%3A%2F%2Fgnu%2Eorg%2Flicenses%2Flgpl%2Etxt%20GNU%20Lesser%20General%20Public%20License%0A%20%2A%20%40link%20%20%20%20%20%20%20%20%20http%3A%2F%2Fgithub%2Ecom%2FFlorianWolters%2Fjekyll%2Dbootstrap%2Dtheme%0A%20%2A%20%40media%20%20%20%20%20%20%20%20all%0A%20%2A%20%40valid%20%20%20%20%20%20%20%20true%0A%20%2A%2F%0A%0Abody%20%7B%0A%20%20%20%20font%2Dfamily%3A%20Helvetica%2C%20Arial%2C%20Freesans%2C%20clean%2C%20sans%2Dserif%3B%0Apadding%3A1em%3B%0Amargin%3Aauto%3B%0Amax%2Dwidth%3A42em%3B%0Abackground%3A%23fefefe%3B%0A%7D%0A%0Ah1%2C%20h2%2C%20h3%2C%20h4%2C%20h5%2C%20h6%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%0A%7D%0A%0Ah1%20%7B%0A%20%20%20%20color%3A%20%23000000%3B%0A%20%20%20%20font%2Dsize%3A%2028px%3B%0A%7D%0A%0Ah2%20%7B%0A%20%20%20%20border%2Dbottom%3A%201px%20solid%20%23CCCCCC%3B%0A%20%20%20%20color%3A%20%23000000%3B%0A%20%20%20%20font%2Dsize%3A%2024px%3B%0A%7D%0A%0Ah3%20%7B%0A%20%20%20%20font%2Dsize%3A%2018px%3B%0A%7D%0A%0Ah4%20%7B%0A%20%20%20%20font%2Dsize%3A%2016px%3B%0A%7D%0A%0Ah5%20%7B%0A%20%20%20%20font%2Dsize%3A%2014px%3B%0A%7D%0A%0Ah6%20%7B%0A%20%20%20%20color%3A%20%23777777%3B%0A%20%20%20%20background%2Dcolor%3A%20inherit%3B%0A%20%20%20%20font%2Dsize%3A%2014px%3B%0A%7D%0A%0Ahr%20%7B%0A%20%20%20%20height%3A%200%2E2em%3B%0A%20%20%20%20border%3A%200%3B%0A%20%20%20%20color%3A%20%23CCCCCC%3B%0A%20%20%20%20background%2Dcolor%3A%20%23CCCCCC%3B%0A%7D%0A%0Ap%2C%20blockquote%2C%20ul%2C%20ol%2C%20dl%2C%20li%2C%20table%2C%20pre%20%7B%0A%20%20%20%20margin%3A%2015px%200%3B%0A%7D%0A%0Acode%2C%20pre%20%7B%0A%20%20%20%20border%2Dradius%3A%203px%3B%0A%20%20%20%20background%2Dcolor%3A%20%23F8F8F8%3B%0A%20%20%20%20color%3A%20inherit%3B%0A%7D%0A%0Acode%20%7B%0A%20%20%20%20border%3A%201px%20solid%20%23EAEAEA%3B%0A%20%20%20%20margin%3A%200%202px%3B%0A%20%20%20%20padding%3A%200%205px%3B%0A%7D%0A%0Apre%20%7B%0A%20%20%20%20border%3A%201px%20solid%20%23CCCCCC%3B%0A%20%20%20%20line%2Dheight%3A%201%2E25em%3B%0A%20%20%20%20overflow%3A%20auto%3B%0A%20%20%20%20padding%3A%206px%2010px%3B%0A%7D%0A%0Apre%20%3E%20code%20%7B%0A%20%20%20%20border%3A%200%3B%0A%20%20%20%20margin%3A%200%3B%0A%20%20%20%20padding%3A%200%3B%0A%7D%0A%0Aa%2C%20a%3Avisited%20%7B%0A%20%20%20%20color%3A%20%234183C4%3B%0A%20%20%20%20background%2Dcolor%3A%20inherit%3B%0A%20%20%20%20text%2Ddecoration%3A%20none%3B%0A%7D%0A" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#proposal-to-allow-looping-of-previously-unlooped-datanames">Proposal to allow looping of previously unlooped datanames</a><ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#proposal-summary">Proposal summary</a></li>
<li><a href="#definitions">Definitions</a></li>
<li><a href="#proposal-in-detail">Proposal in detail</a><ul>
<li><a href="#domain-dictionaries">Domain dictionaries</a></li>
<li><a href="#drel">dREL</a></li>
</ul></li>
<li><a href="#discussion">Discussion</a><ul>
<li><a href="#legacy-issues">Legacy issues</a></li>
</ul></li>
<li><a href="#appendix-i-definition-of-_audit.schema">Appendix I: definition of <code>_audit.schema</code></a></li>
<li><a href="#appendix-ii-definitions-of-master-hub-category-and-sample-key">Appendix II: Definitions of master hub category and sample key</a></li>
<li><a href="#example-of-a-child-key-definition">Example of a child key definition</a></li>
</ul></li>
</ul>
</div>
<h1 id="proposal-to-allow-looping-of-previously-unlooped-datanames">Proposal to allow looping of previously unlooped datanames</h1>
<h2 id="introduction">Introduction</h2>
<p>In the original DDL1 and the current version of DDLm, categories must be explicitly labelled as loopable in order for their datanames to appear in multi-row loops. In DDL2, all categories are notionally loopable, but datanames for which only one value is allowed per datablock are restricted to single-row loops (or equivalently, key-value pairs) by linking their category key to a one-value-per-block 'entry' category.</p>
<p>In some situations, being able to loop a conventionally category is desirable. For example, structural data might be presented in both standard and alternate space group settings, meaning multiple space groups are included in the datablock. While such a use of CIF datanames may appear to be benign, it can easily lead to CIF-reading software silently producing incorrect results. The underlying reason for this is that interpretation of looped dataname values often depends on values of unlooped datanames (e.g. unit cell parameters are needed to transform fractional coordinates into distances), and more than one value for these unlooped datanames therefore leads to ambiguity.</p>
<p>We here propose a mechanism that allows any dataname to appear in a multi-row loop, while protecting current software from inadvertent misinterpretation of such files.</p>
<h2 id="proposal-summary">Proposal summary</h2>
<p>A new dataname, <code>_audit.schema</code>, is defined and must be checked by all CIF-reading software. Values of this dataname are linked to special categories that are used to loop and link other categories together. All CIF-reading software should check this dataname. CIF-writing software need only set this dataname if a non-default value is chosen.</p>
<h2 id="definitions">Definitions</h2>
<p>For ease of discussion we adopt some terminology from relational databases:</p>
<ul>
<li>A <em>compound key</em> is a set of datanames whose values collectively determine a unique row in a loop</li>
<li>A <em>key</em> is a dataname that is part of a compound key</li>
<li>A <em>child key</em> is a key whose values are restricted to values taken by a <em>parent</em> key.</li>
<li><em>Sibling keys</em> are keys that have a common parent key</li>
</ul>
<h2 id="proposal-in-detail">Proposal in detail</h2>
<p>This proposal affects only the domain dictionaries and dREL.</p>
<h3 id="domain-dictionaries">Domain dictionaries</h3>
<ol style="list-style-type: lower-roman">
<li><p>Dataname <code>_audit.schema</code> is added to the core dictionary, and all CIF reading software is expected, after a transitional period, to check its value; if missing, the value defaults to <code>Base</code>, corresponding to all current CIF datafiles. See Appendix I for a formal DDLm definition.</p></li>
<li><p>A 'master hub' Loop category is added to the cif_core dictionary, corresponding to the default value of <code>_audit.schema</code>. The main role of this category is to restrict datanames to a single value, which mimics current CIF usage (see next point). This category contains a single key dataname provided with a default value, meaning that the category may be omitted from the datafile if only one packet is present (the case for all currently valid CIF files). See Appendix II for a draft definition.</p></li>
<li><p>All categories are provided with a 'master hub' child key. This is the only key provided for 'Set' categories in the core dictionary, thus restricting 'Set' categories to a single value for each dataname whenever the 'master hub' has a single entry (the default). The designation of a category as 'Set' is thus equivalent to stating that it has a single key which takes a single value in a datablock.</p></li>
<li><p>Once <code>_audit.schema</code> checking is widespread, expansion dictionaries are allowed to add keys to previously-defined categories. Datafiles written according to the expansion dictionaries must set _audit.schema appropriately, and change the 'Set' designation of any categories that can now be written with multiple loop packets.</p></li>
</ol>
<h3 id="drel">dREL</h3>
<p>dREL expects methods that reference looped categories outside the current category to explicitly construct the key to those categories. In a situation where the list of keys for that category and the current category may be altered by an expansion dictionary, such explicit key construction requires duplication of functionally identical code, clutters the definition and is generally unnecessary, because, in most cases, a unique row for the external category can be derived from the current values of the current category's keys.</p>
<p>In addition, dREL refers to external 'Set' categories without any use of keys, although formally all categories now have keys.</p>
<p>dREL is therefore altered to behave as follows:</p>
<p>In non-category methods:</p>
<ol style="list-style-type: decimal">
<li><p>All uses of the &quot;dot&quot; operator of the form <code>cat.name</code> implicitly assume the values of any sibling compound keys for <code>cat</code> currently in scope.</p></li>
<li><p>All Loop operations restrict packets of the looped category to those that have common values for any sibling compound keys in scope (a 'pre-filter' operation)</p></li>
<li><p>If rule (1) does not lift ambiguity, keys may be listed in the format <code>cat[key1_val, key2_val].name</code> (a dREL syntax enhancement).</p></li>
<li><p>(General style) Given that compound keys are directly accessed in the above rules, so-called ID (primary) key datanames constructed from the values of compound keys are avoided in dREL methods. In particular, their values should never be deconstructed or assigned to other datanames, and may only be constructed within category methods.</p></li>
</ol>
<p>In category methods:</p>
<p>dREL category methods are required to set the values of all compound keys in order to create the category. In order for new keys to be added without changing the method unnecessarily, the following rule is adopted:</p>
<ol start="4" style="list-style-type: decimal">
<li>The category method is repeatedly executed for every combination of those compound key values for which no values are explicitly set by the category method. Execution follows the rules for normal methods, with the compound key values described in the previous sentence placed in scope.</li>
</ol>
<h2 id="discussion">Discussion</h2>
<p>Although this proposal involves adding an extra key dataname to virtually all categories, by giving a default value for these datanames they can effectively be left out of datafiles (or ignored) as long as the master hub has only one row. The default value of <code>_audit.schema</code> refers to exactly this situation. Minimal space will be occupied in the dictionary file by these definitions due to use of the templating mechanism.</p>
<p>Each <code>_audit.schema</code> value refers to a distinct set of categories that can have multiple packets. Software written for <code>_audit.schema</code> &quot;A&quot; will in general only function correctly for a file written against <code>_audit.schema</code> &quot;B&quot; if the set of multiple-packet categories for &quot;B&quot; is a subset of those for &quot;A&quot;.</p>
<p>Note that <code>_audit.schema</code> is advisory and that the same information can be determined from the dictionaries listed in <code>audit_conform</code>.</p>
<h3 id="legacy-issues">Legacy issues</h3>
<p>One category (<code>space_group</code>) in the DDL1 cif core dictionary was mistakenly allowed to be looped without making corresponding alterations to the many other categories that relied upon having a single space group. This is fixed under the current proposal as follows:</p>
<ol style="list-style-type: lower-roman">
<li>category <code>space_group</code> is, as for most other categories, given a child key of the master hub key, thereby limiting it to a single value in ordinary CIF data files;</li>
<li><code>space_group.id</code>, <code>space_group_Wyckoff.sg_id</code> and <code>space_group_symop.sg_id</code> are removed</li>
</ol>
<p>In a separate DDLm dictionary file (a successor to symCIF):</p>
<ol start="3" style="list-style-type: lower-roman">
<li>a new category, <code>space_group_tables</code> is defined, containing a single default-valued (key) dataname;</li>
<li>all categories that previously assumed a single space group are provided with child keys of <code>space_group_tables</code>. In particular, the keys removed in step (ii) above are redefined as child keys of <code>space_group</code>.</li>
</ol>
<p>Finally: (v) a new enumerated value of <code>_audit.schema</code> is defined, (e.g. 'space group tables') corresponding to a datablock possibly containing multiple packets in the category <code>space_group_tables</code>.</p>
<h2 id="appendix-i-definition-of-_audit.schema">Appendix I: definition of <code>_audit.schema</code></h2>
<pre><code>_definition.id       '_audit.schema'
_name.category_id    audit
_name.object_id      schema
_description.text
;

     This dataname identifies the type of information contained in the
     datablock. Software written for one schema will not, in general,
     correctly interpret datafiles written against a different schema.

     Specifically, each value of _audit.schema corresponds to a list
     of categories that were restricted to a single packet in the
     default Base schema, but which can contain multiple packets in
     the specified schema.  All categories containing child keys of
     the listed categories may also contain multiple packets and do
     not need to be listed.
     
     The category list for each schema may instead be determined from
     the list of dictionaries that this datablock conforms to (see
     _audit_conform.dictionary).

;
_type.contents          Text
_type.purpose           State
_type.container         Single
_type.source            Assigned
loop_
_enumeration_set.state
_enumeration_set.detail
    Base                'Original Core CIF schema'
   'Space group tables'  [ space_group_tables ]
    Custom              'Examine dictionaries provided in _audit_conform'
    Local               'Locally modified dictionaries. These datafiles should not be distributed'
_enumeration.default    Base</code></pre>
<h2 id="appendix-ii-definitions-of-master-hub-category-and-sample-key">Appendix II: Definitions of master hub category and sample key</h2>
<pre><code>save_ENTRY

_definition.id                          ENTRY
_definition.scope                       Category
_definition.class                       Loop
_description.text
;
    All categories in a datablock have a child key of this
    category.  This category makes explicit the links implied
    by the grouping together of categories in a datablock,
;
_name.category_id                       CIF_CORE
_name.object_id                         ENTRY
_category_key.name                      '_entry.id'

save_

save_entry.id

_definition.id                          '_entry.id'
_description.text
;
    A unique identifier for items in this category.
;

_name.category_id                       ENTRY
_name.object_id                         id
_type.purpose                           Key
_type.container                         Single
_type.contents                          Text
_type.source                            Assigned
_enumeration.default                    -

save_</code></pre>
<h2 id="example-of-a-child-key-definition">Example of a child key definition</h2>
<pre><code>save_space_group.entry_id

_definition.id                         '_space_group.entry_id'
_name.category_id                      'space_group'
_name.object_id                        'entry_id'
_description.text
;
    A child key of the entry category. This dataname may
    be omitted from a datafile if the entry category has only
    one packet.
;
_type.purpose                      Link
_type.container                    Single
_type.contents                     Text
_type.source                       Related
_name.linked_item_id               '_entry.id'

save_</code></pre>
</body>
</html>
